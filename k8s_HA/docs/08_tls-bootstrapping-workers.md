# 🛠️ Kubernetes Bootstrap Token & Kubelet Bootstrapping Setup

This guide walks you through configuring **bootstrap tokens**, **CSR auto-approval**, **kubelet**, and **kube-proxy** setup for worker node bootstrapping in a Kubernetes cluster.

---

## 📦 Why This Is Important

Bootstrapping allows new worker nodes to securely join the cluster using a temporary token. The kubelet uses this token to request a signed certificate from the control plane. Once approved, it can communicate securely with the API server.

---

## 🔍 Prerequisite Verifications

Ensure the API server accepts bootstrap tokens and that the controller-manager can sign CSRs:

```bash
grep 'enable-bootstrap-token-auth=true' /etc/systemd/system/kube-apiserver.service && \
grep 'cluster-signing-cert-file=/var/lib/kubernetes/pki/ca.crt' /etc/systemd/system/kube-controller-manager.service && \
grep 'cluster-signing-key-file=/var/lib/kubernetes/pki/ca.key' /etc/systemd/system/kube-controller-manager.service
```

These confirm that token-based auth and certificate signing are properly configured.

---

## 🔐 Step 1: Create a Bootstrap Token

A bootstrap token is used by the kubelet to authenticate and request a certificate.

```bash
EXPIRATION=$(date -u --date "+2 days" +"%Y-%m-%dT%H:%M:%SZ")

cat > bootstrap-token-02526a.yaml <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: bootstrap-token-02526a
  namespace: kube-system
type: bootstrap.kubernetes.io/token
stringData:
  description: "The default bootstrap token generated by 'kubeadm init'."
  token-id: 02526a
  token-secret: 9a7e2bcf1d4a8e7f
  expiration: ${EXPIRATION}
  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"
  auth-extra-groups: system:bootstrappers:worker
EOF

kubectl create -f bootstrap-token-02526a.yaml --kubeconfig admin.kubeconfig
```

---

## ✅ Step 2: RBAC for Bootstrap Token CSR Creation and Auto-Approval

These RBAC bindings allow the kubelet to:
- Submit CSRs (certificate signing requests)
- Automatically get those CSRs approved
- Auto-renew its certs later

### CSR Creation Role Binding
```bash
cat > csrs-for-bootstrapping.yaml <<EOF
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: create-csrs-for-bootstrapping
subjects:
- kind: Group
  name: system:bootstrappers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:node-bootstrapper
  apiGroup: rbac.authorization.k8s.io
EOF

kubectl create -f csrs-for-bootstrapping.yaml --kubeconfig admin.kubeconfig
```

### Auto-Approve Bootstrap CSRs
```bash
cat > auto-approve-csrs-for-group.yaml <<EOF
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: auto-approve-csrs-for-group
subjects:
- kind: Group
  name: system:bootstrappers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
  apiGroup: rbac.authorization.k8s.io
EOF

kubectl create -f auto-approve-csrs-for-group.yaml --kubeconfig admin.kubeconfig
```

### Auto-Approve Renewals for Nodes
```bash
cat > auto-approve-renewals-for-nodes.yaml <<EOF
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: auto-approve-renewals-for-nodes
subjects:
- kind: Group
  name: system:nodes
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
  apiGroup: rbac.authorization.k8s.io
EOF

kubectl create -f auto-approve-renewals-for-nodes.yaml --kubeconfig admin.kubeconfig
```

---

## 📦 Step 3: Install Kubelet and Kube-Proxy Binaries

These components are required to run pods (`kubelet`) and manage networking (`kube-proxy`) on worker nodes.

```bash
KUBE_VERSION=$(curl -L -s https://dl.k8s.io/release/stable.txt)
ARCH=amd64

wget -q --show-progress --https-only --timestamping \
  https://dl.k8s.io/release/${KUBE_VERSION}/bin/linux/${ARCH}/kube-proxy \
  https://dl.k8s.io/release/${KUBE_VERSION}/bin/linux/${ARCH}/kubelet

chmod +x kube-proxy kubelet
sudo mv kube-proxy kubelet /usr/local/bin/
```

---

## 📁 Step 4: Prepare Required Directories and Certificates

Creates required directories and copies CA and kube-proxy certificates.

```bash
sudo mkdir -p \
  /var/lib/kubelet/pki \
  /var/lib/kube-proxy \
  /var/lib/kubernetes/pki \
  /var/run/kubernetes

sudo mv ca.crt kube-proxy.crt kube-proxy.key /var/lib/kubernetes/pki
sudo chown root:root /var/lib/kubernetes/pki/*
sudo chmod 600 /var/lib/kubernetes/pki/*
```

---

## 📄 Step 5: Create Bootstrap Kubeconfig for Kubelet

This tells the kubelet where to find the API server and how to authenticate using the bootstrap token.

```bash
LOADBALANCER=$(getent hosts lb | awk '{ print $1 }')

cat <<EOF | sudo tee /var/lib/kubelet/bootstrap-kubeconfig
apiVersion: v1
clusters:
- cluster:
    certificate-authority: /var/lib/kubernetes/pki/ca.crt
    server: https://${LOADBALANCER}:6443
  name: bootstrap
contexts:
- context:
    cluster: bootstrap
    user: kubelet-bootstrap
  name: bootstrap
current-context: bootstrap
kind: Config
preferences: {}
users:
- name: kubelet-bootstrap
  user:
    token: 02526a.9a7e2bcf1d4a8e7f
EOF
```

---

## ⚙️ Step 6: Configure Kubelet

This config file defines authentication, authorization, DNS, cgroups, and TLS bootstrapping.

```bash
SERVICE_CIDR=10.96.0.0/16
CLUSTER_DNS=$(echo $SERVICE_CIDR | awk 'BEGIN {FS="."} ; { printf("%s.%s.%s.10", $1, $2, $3) }')

cat <<EOF | sudo tee /var/lib/kubelet/kubelet-config.yaml
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous:
    enabled: false
  webhook:
    enabled: true
  x509:
    clientCAFile: /var/lib/kubernetes/pki/ca.crt
authorization:
  mode: Webhook
containerRuntimeEndpoint: unix:///var/run/containerd/containerd.sock
cgroupDriver: systemd
clusterDomain: "cluster.local"
clusterDNS:
  - ${CLUSTER_DNS}
registerNode: true
resolvConf: /run/systemd/resolve/resolv.conf
rotateCertificates: true
runtimeRequestTimeout: "15m"
serverTLSBootstrap: true
EOF
```

---

## 🔧 Step 7: Create Kubelet systemd Unit File

This systemd unit will run the kubelet using the bootstrap token until it receives a client cert.

```bash
PRIMARY_IP=$(hostname -I | grep -o '192\.168\.[0-9]\+\.[0-9]\+')

cat <<EOF | sudo tee /etc/systemd/system/kubelet.service
[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=containerd.service
Requires=containerd.service

[Service]
ExecStart=/usr/local/bin/kubelet \\
  --bootstrap-kubeconfig="/var/lib/kubelet/bootstrap-kubeconfig" \\
  --config=/var/lib/kubelet/kubelet-config.yaml \\
  --kubeconfig=/var/lib/kubelet/kubeconfig \\
  --cert-dir=/var/lib/kubelet/pki/ \\
  --node-ip=${PRIMARY_IP} \\
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
```

---

## ⚙️ Step 8: Configure and Enable Kube Proxy

Kube-proxy handles routing and service IP NAT for pods.

```bash
POD_CIDR=10.244.0.0/16

cat <<EOF | sudo tee /var/lib/kube-proxy/kube-proxy-config.yaml
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
clientConnection:
  kubeconfig: /var/lib/kube-proxy/kube-proxy.kubeconfig
mode: iptables
clusterCIDR: ${POD_CIDR}
EOF
```

Create the kube-proxy.service systemd unit file:

```bash
cat <<EOF | sudo tee /etc/systemd/system/kube-proxy.service
[Unit]
Description=Kubernetes Kube Proxy
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-proxy \\
  --config=/var/lib/kube-proxy/kube-proxy-config.yaml
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
```

---

## 🚀 Step 9: Start Kubelet and Kube Proxy

Starts both services so the node can join the cluster and manage networking.

```bash
sudo systemctl daemon-reload
sudo systemctl enable kubelet kube-proxy
sudo systemctl start kubelet kube-proxy
```

---

## 🔎 Step 10: Approve CSR and Verify Node Join

Once the kubelet sends a CSR, it must be manually approved (unless auto-approval is enabled).

```bash
kubectl get csr --kubeconfig admin.kubeconfig
kubectl certificate approve <csr-name> --kubeconfig admin.kubeconfig
kubectl get nodes --kubeconfig admin.kubeconfig
```

> 🎉 After CSR approval, the worker node should show up as `Ready`.
